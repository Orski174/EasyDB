-- Detect suppliers whose products contribute to at least 25% of the total orders in the factory.

WITH TotalOrders AS (
    SELECT 
        SUM(Quantity) AS total_quantity
    FROM 
        Material_Trans
),
SupplierOrders AS (
    SELECT 
        s.Supp_ID, 
        s.Supp_Name, 
        SUM(ss.Quantity) AS supplier_quantity
    FROM 
        Suppliers s
    JOIN 
        Material_Trans p ON s.Supp_ID = p.supplier_id
    JOIN 
        Material_Trans mt ON p.Mat_Name = mt.Mat_Name
    GROUP BY 
        s.Supp_ID, s.Supp_Name
)
SELECT 
    so.Supp_Name, 
    so.supplier_quantity, 
    ROUND((so.supplier_quantity::DECIMAL / to.total_quantity) * 100, 2) AS percentage
FROM 
    SupplierOrders so, TotalOrders to
WHERE 
    (so.supplier_quantity::DECIMAL / to.total_quantity) >= 0.25;